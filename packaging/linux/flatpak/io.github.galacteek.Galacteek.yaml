app-id: io.github.galacteek.Galacteek
runtime: org.freedesktop.Platform
runtime-version: '19.08'
sdk: org.freedesktop.Sdk
command: galacteek
finish-args:
  - --share=ipc
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=fallback-x11
  - --share=network
  - --device=all
  - --filesystem=home

modules:
  - name: galacteek-conda
    buildsystem: simple
    build-commands:
      - bash Miniconda3-py37_4.8.3-Linux-x86_64.sh -b -p ${FLATPAK_DEST} -f
      - conda install -y -c conda-forge libxkbcommon pip
      - conda install -y --no-deps libxcb
    build-options:
      build-args:
        - --share=network
    sources:
      - type: file
        url: "https://repo.anaconda.com/miniconda/Miniconda3-py37_4.8.3-Linux-x86_64.sh"
        md5: "751786b92c00b1aeae3f017b781018df"

  - name: galacteek
    buildsystem: simple
    build-commands:
      # Create directories for license, metainfo, icons
      - mkdir -p ${FLATPAK_DEST}/share/licenses/galacteek
      - mkdir -p ${FLATPAK_DEST}/share/applications
      - mkdir -p ${FLATPAK_DEST}/share/metainfo
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps

      - cp galacteek.appdata.xml
          ${FLATPAK_DEST}/share/metainfo/io.github.galacteek.Galacteek.xml
      - cp {LICENSE,LICENSE.go-ipfs,LICENSE.Qt.GPLv3}
          ${FLATPAK_DEST}/share/licenses/galacteek
      - cp galacteek.desktop
          ${FLATPAK_DEST}/share/applications/io.github.galacteek.Galacteek.desktop
      - cp share/icons/galacteek.png
        ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps

      # Copy zbar and libjpeg
      - find /usr/lib -iname 'libzbar.so*' -exec cp -av {} ${FLATPAK_DEST}/lib \;
      - find /usr/lib -iname 'libjpeg.so*' -exec cp -av {} ${FLATPAK_DEST}/lib \;

      # Copy go-ipfs and fs-repo-migrations
      - cp $GITHUB_WORKSPACE/go-ipfs/ipfs-${GO_IPFS_VERSION}
          ${FLATPAK_DEST}/bin
      - cp $GITHUB_WORKSPACE/fs-repo-migrations/fs-repo-migrations
          ${FLATPAK_DEST}/bin

      # Copy notbit, create symlinks
      - cp $GITHUB_WORKSPACE/notbit/src/notbit ${FLATPAK_DEST}/bin
      - ln -s ${FLATPAK_DEST}/bin/notbit ${FLATPAK_DEST}/bin/notbit-keygen
      - ln -s ${FLATPAK_DEST}/bin/notbit ${FLATPAK_DEST}/bin/notbit-sendmail
 
      # Activate the conda venv
      - source ${FLATPAK_DEST}/bin/activate

      # Install requirements; build and install via setup.py
      - pip install -r requirements.txt
      - python3 setup.py build install
    build-options:
      build-args:
        - --share=network
    sources:
      - type: git
        url: ssh://git@github.com/pinnaculum/galacteek.git

cleanup:
  - 'pkgs'
  - 'lib/cmake'
  - 'include'
  - 'share/{gtk-,}doc'
  - 'bin/tcl*'
  - 'bin/lz*'
  - 'bin/xz*'
  - 'lib/libtcl*'
  - 'lib/libtk*'
  - 'lib/tk*'
  - 'lib/tcl*'
  - 'lib/python3.7/site-packages/Cryptodome/SelfTest/*'
  - 'lib/python3.7/site-packages/PyQt5/Qt/plugins/geoservices'
  - 'lib/python3.7/site-packages/PyQt5/Qt/plugins/sceneparsers'
  - 'lib/python3.7/site-packages/pyzbar/tests'
  - 'lib/python3.7/turtledemo'
  - 'lib/python3.7/tkinter'
  - 'lib/python3.7/lib2to3'
  - 'lib/python3.7/idlelib'
  - 'lib/python3.7/site-packages/git/test'
  - 'lib/python3.7/site-packages/conda_package_handling'
  - 'lib/python3.7/ensurepip'
  - 'lib/python3.7/site-packages/{setuptools,pip}'
  - 'lib/python3.7/site-packages/PyQt5/Qt/plugins/sqldrivers'
  - 'lib/python3.7/site-packages/PyQt5/Qt/lib/libQt5XmlPatterns*'
  - 'lib/python3.7/site-packages/PyQt5/Qt/lib/libQt5Designer*'
  - 'lib/python3.7/site-packages/PyQt5/Qt/qml/QtCharts/designer/images'
  - 'lib/python3.7/site-packages/PyQt5/Qt/qml/Qt/labs'
  - 'share/man'
  - 'share/readline'
  - 'share/terminfo'
  - 'share/info'
  - 'ssl/man'
  - 'lib/libstdc++*'

  # - 'lib/libxcb-dri2.so*'
  # - 'lib/libxcb-dri3.so*'
  # - 'lib/libxcb.so*'
